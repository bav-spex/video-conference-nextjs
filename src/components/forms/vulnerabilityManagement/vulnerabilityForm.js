import React, { useState, useEffect } from 'react'

import { yupResolver } from '@hookform/resolvers/yup'
import ClearRoundedIcon from '@mui/icons-material/ClearRounded'
import { Typography } from '@mui/material'
import Box from '@mui/material/Box'
import Button from '@mui/material/Button'
import CircularProgress from '@mui/material/CircularProgress'
import FormControl from '@mui/material/FormControl'
import FormHelperText from '@mui/material/FormHelperText'
import Grid from '@mui/material/Grid'
import InputLabel from '@mui/material/InputLabel'
import MenuItem from '@mui/material/MenuItem'
import Select from '@mui/material/Select'
import { useTheme } from '@mui/material/styles'
import TextField from '@mui/material/TextField'
import { CommonSwal } from 'components/CommonSwal'
import authConfig from 'configs/auth'
import moment from 'moment'
import { useRouter } from 'next/router'
import { useForm } from 'react-hook-form'
import { useTranslation } from 'react-i18next'
import {
  getAdditionlStakeHoldersDropDown,
  getAssetTypeDropdown,
  getSiteLocationDropDown,
  getVulnerabilityType,
  getSeverityRating,
  getLikelyHood,
  getRiskValue
} from 'services/common'
import { getAllAssets } from 'services/Risks/assets/AssetService'
import { getRisks } from 'services/Risks/RiskService'
import apiHelper from 'store/apiHelper'
import * as yup from 'yup'

import RiskMappingDrawer from './riskMappingDrawer'

const VulnerabilityForm = ({ formType, vulnerabilityId, vulnerabilityData }) => {
  const router = useRouter()
  const { t } = useTranslation()
  const theme = useTheme()
  const [loading, setLoading] = useState(true)

  const [singleVulnerabilityData, setVulnerabilityData] = useState(vulnerabilityData)

  const [savingForm, setSavingForm] = useState(false)

  const [location_dropdown, setLocation_dropdown] = useState([])
  const [assetType_dropdown, setAssetType_dropdown] = useState([])
  const [vulnerabilityType_dropdown, setVulnerabilityType_dropdown] = useState([])
  const [severityRating_dropdown, setSeverityRating_dropdown] = useState([])
  const [likelyHood_dropdown, setLikelyHood_dropdown] = useState([])
  const [riskValue_dropdown, set_riskValue_dropdown] = useState([])
  const [assets_dropdown, setAssets_dropdown] = useState([])
  const [owner_dropdown, setOwner_dropdown] = useState([])

  const [openRiskMappingDrawer, setOpenRiskMappingDrawer] = useState(false)
  const [risk_dropdown, set_risk_dropdown] = useState([])
  const [riskMappingIds, setRiskMappingIds] = useState([])
  const [riskDropdownIds, setRiskDropdownIds] = useState([])
  const [riskError, setRiskError] = useState()

  useEffect(() => {
    if (vulnerabilityData) {
      const normalizedData = {
        ...vulnerabilityData,
        targetdate: vulnerabilityData.targetDate
          ? moment(vulnerabilityData.targetDate).isValid()
            ? moment(vulnerabilityData.targetDate).format('YYYY-MM-DD')
            : getTodayUTC()
          : getTodayUTC()
      }
      setRiskMappingIds([...vulnerabilityData.mappedrisk])
      setVulnerabilityData(normalizedData)
    }
  }, [vulnerabilityData])

  const validationSchema = yup.object().shape({
    name: yup.string().min(1, 'Must be at least 1 characters').required('This field is required'),
    description: yup.string().min(1, 'Must be at least 1 characters').required('This field is required'),
    impact: yup.string().min(1, 'Must be at least 1 characters').required('This field is required'),
    recommendation: yup.string().min(1, 'Must be at least 1 characters').required('This field is required'),
    owner: yup.number().notOneOf([0], 'Owner is required').required('Owner is required'),
    score: yup.number().typeError('Score is required').required('Score is required'),
    targetdate: yup
      .string()
      .required('Target Date is required')
      .test('is-future-date', 'Target date must be in the future', value => {
        return moment(value).isSameOrAfter(moment(), 'day')
      }),
    vulnerabilityType: yup.number().typeError('Type is required').required('Type is required'),
    severityRating: yup.number().typeError('Rating is required').required('Rating is required'),
    likeliyhood: yup.number().typeError('Likelyhood is required').required('Likelyhood is required'),
    risk: yup.number().typeError('Risk is required').required('Risk is required'),
    affectedAssets: yup.number().typeError('Asset is required').required('Asset is required')
  })

  useEffect(() => {
    getAssetTypeDropdown(setAssetType_dropdown, () => {})
    getSiteLocationDropDown(setLocation_dropdown, () => {})
    getVulnerabilityType(setVulnerabilityType_dropdown)
    getSeverityRating(setSeverityRating_dropdown)
    getLikelyHood(setLikelyHood_dropdown)
    getRiskValue(set_riskValue_dropdown)
    getAllAssets(setAssets_dropdown)
    getAdditionlStakeHoldersDropDown(setOwner_dropdown)
    getRisks(set_risk_dropdown)
  }, [])

  useEffect(() => {
    if (
      location_dropdown.length > 0 &&
      assetType_dropdown.length > 0 &&
      vulnerabilityType_dropdown.length > 0 &&
      severityRating_dropdown.length > 0 &&
      likelyHood_dropdown.length > 0 &&
      riskValue_dropdown.length > 0 &&
      owner_dropdown.length > 0 &&
      assets_dropdown.length > 0 &&
      risk_dropdown.length > 0
    ) {
      setLoading(false)
    }
  }, [
    assetType_dropdown,
    assets_dropdown,
    likelyHood_dropdown,
    location_dropdown,
    riskValue_dropdown,
    owner_dropdown,
    risk_dropdown,
    severityRating_dropdown,
    vulnerabilityType_dropdown
  ])

  // auditName
  // categoryId
  // frameworkId
  // ownerId
  // statusId
  const handleChange = (name, value) => {
    setVulnerabilityData({ ...singleVulnerabilityData, [name]: value })
  }

  const handleRiskChange = id => {
    let updated = [...riskMappingIds]
    if (updated.includes(id)) {
      updated = updated.filter(item => item !== id)
    } else {
      updated.push(id)
    }
    setRiskMappingIds(updated)
  }

  useEffect(() => {
    if (singleVulnerabilityData) {
      setRiskDropdownIds([...riskMappingIds])
    }
  }, [riskMappingIds])

  // ** Hooks
  const {
    control,
    handleSubmit,
    formState: { errors },
    register
  } = useForm({
    resolver: yupResolver(validationSchema),
    mode: 'onSubmit'
  })

  const handleFormSubmit = () => {
    const payload = {
      ...singleVulnerabilityData,
      mappedrisk: riskMappingIds,
      targetDate: moment(singleVulnerabilityData.targetdate, 'YYYY-MM-DD').toISOString()
    }

    onSubmit(payload)
  }

  const onSubmit = async payload => {
    try {
      setSavingForm(true)
      let res
      if (formType === 'edit') {
        res = await apiHelper(
          `${authConfig.riskDevRakshitah_base_url}vulnerability/updateById/${vulnerabilityId}`,
          'put',
          payload,
          {}
        )
        CommonSwal(theme, {
          icon: 'success',
          title: res?.data?.data?.msg || 'Edited successfully!',
          showConfirmButton: true
        })
      } else {
        res = await apiHelper(`${authConfig.riskDevRakshitah_base_url}vulnerability/new`, 'post', payload, {})
        CommonSwal(theme, {
          icon: 'success',
          title: res?.data?.data?.msg || 'Added successfully!',
          showConfirmButton: true
        })
      }
      router.push(`/home/vulnerabilityManagement/vulnerability`)
    } catch (err) {
      console.error(err)
      CommonSwal(theme, {
        icon: 'error',
        title: err?.response?.data || 'Something went wrong!',
        icon: 'error',
        confirmButtonText: 'OK'
      })
    } finally {
      setSavingForm(false)
    }
  }

  return (
    <>
      <form onSubmit={handleSubmit(handleFormSubmit)}>
        <Box className='hide-scrollbar'>
          {loading ? (
            <Box
              sx={{
                height: '50vh',
                display: 'flex',
                alignItems: 'center',
                flexDirection: 'column',
                justifyContent: 'center'
              }}
            >
              <CircularProgress disableShrink sx={{ mt: 6, color: theme.palette.company.primary }} />
            </Box>
          ) : (
            <>
              <Grid container spacing={7.5} marginTop={'0px'}>
                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <TextField
                      {...register('name')}
                      id='outlined-name'
                      type='text'
                      label='Vulnerability Name *'
                      variant='outlined'
                      disabled={formType === 'view'}
                      value={singleVulnerabilityData.name}
                      onChange={e => handleChange('name', e.target.value)}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{errors.name?.message}</FormHelperText>
                  </FormControl>
                </Grid>
                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth required>
                    <TextField
                      {...register('description')}
                      id='outlined-description'
                      type='text'
                      label='Description *'
                      variant='outlined'
                      disabled={formType === 'view'}
                      value={singleVulnerabilityData.description}
                      onChange={e => handleChange('description', e.target.value)}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.description?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth required>
                    <TextField
                      {...register('impact')}
                      id='outlined-impact'
                      type='text'
                      label='Impact *'
                      variant='outlined'
                      disabled={formType === 'view'}
                      value={singleVulnerabilityData.impact}
                      onChange={e => handleChange('impact', e.target.value)}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{errors.impact?.message}</FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth required>
                    <TextField
                      {...register('recommendation')}
                      id='outlined-recommendation'
                      type='text'
                      label='Recommendation *'
                      variant='outlined'
                      disabled={formType === 'view'}
                      value={singleVulnerabilityData.recommendation}
                      onChange={e => handleChange('recommendation', e.target.value)}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.recommendation?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Owner *')}</InputLabel>
                    <Select
                      {...register('owner')}
                      id='owner'
                      value={singleVulnerabilityData.owner}
                      onChange={e => handleChange('owner', e.target.value)}
                      label={t('Owner *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {owner_dropdown.map(c => (
                        <MenuItem key={c.id} value={Number(c.id)}>
                          {c.userName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{errors.owner?.message}</FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Type')}</InputLabel>
                    <Select
                      {...register('vulnerabilityType')}
                      id='vulnerabilityType'
                      value={singleVulnerabilityData.vulnerabilityType}
                      onChange={e => handleChange('vulnerabilityType', e.target.value)}
                      label={t('Type *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {vulnerabilityType_dropdown.map(c => (
                        <MenuItem key={c.lookupId} value={Number(c.lookupId)}>
                          {c.lookupName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.vulnerabilityType?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Rating *')}</InputLabel>
                    <Select
                      {...register('severityRating')}
                      id='severityRating'
                      value={singleVulnerabilityData.severityRating}
                      onChange={e => handleChange('severityRating', e.target.value)}
                      label={t('Rating *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {severityRating_dropdown.map(c => (
                        <MenuItem key={c.lookupId} value={Number(c.lookupId)}>
                          {c.lookupName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.severityRating?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Likelihood *')}</InputLabel>
                    <Select
                      {...register('likeliyhood')}
                      id='likeliyhood'
                      value={singleVulnerabilityData.likeliyhood}
                      onChange={e => handleChange('likeliyhood', e.target.value)}
                      label={t('Likelihood *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {likelyHood_dropdown.map(c => (
                        <MenuItem key={c.lookupId} value={Number(c.lookupId)}>
                          {c.lookupName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.likeliyhood?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Risk *')}</InputLabel>
                    <Select
                      {...register('risk')}
                      id='risk'
                      value={singleVulnerabilityData.risk}
                      onChange={e => handleChange('risk', e.target.value)}
                      label={t('Risk *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {riskValue_dropdown.map(c => (
                        <MenuItem key={c.lookupId} value={Number(c.lookupId)}>
                          {c.lookupName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{errors.risk?.message}</FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <InputLabel error={Boolean(errors.msg)}>{t('Affected Assets *')}</InputLabel>
                    <Select
                      {...register('affectedAssets')}
                      id='affectedAssets'
                      value={singleVulnerabilityData.affectedAssets}
                      onChange={e => handleChange('affectedAssets', e.target.value)}
                      label={t('Affected Assets *')}
                      MenuProps={{
                        PaperProps: {
                          style: {
                            maxHeight: 150,
                            width: 250
                          }
                        }
                      }}
                    >
                      {assets_dropdown.map(c => (
                        <MenuItem key={c.id} value={Number(c.id)}>
                          {c.assetName}
                        </MenuItem>
                      ))}
                    </Select>
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>
                      {errors.affectedAssets?.message}
                    </FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <TextField
                      {...register('score')}
                      type='number'
                      style={{ width: '100%' }}
                      label={t('Score')}
                      name='score'
                      value={singleVulnerabilityData.score}
                      onChange={e => handleChange('score', e.target.value)}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{errors?.score?.message}</FormHelperText>
                  </FormControl>
                </Grid>

                <Grid item xs={12} sm={6} lg={4}>
                  <FormControl fullWidth>
                    <TextField
                      {...register('targetdate')}
                      label={t('Target Date')}
                      type='date'
                      variant='outlined'
                      value={singleVulnerabilityData.targetdate} // ✅ Correct
                      onChange={e => handleChange('targetdate', e.target.value)} // ✅ Correct
                      inputProps={{
                        min: moment().format('YYYY-MM-DD')
                      }}
                    />
                    <FormHelperText sx={{ color: 'error.main', mx: 0 }}>{errors.targetdate?.message}</FormHelperText>
                  </FormControl>
                </Grid>
                <Grid item xs={12} md={6} lg={6}>
                  <Box sx={{ background: theme.palette.company.lighttertiary }}>
                    <Box
                      sx={{
                        height: '56px',
                        border: '1px solid',
                        background: theme.palette.company.background,
                        borderColor: theme.palette.company.primary,
                        color: theme.palette.company.primary,
                        borderRadius: '5px',
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        cursor: 'pointer'
                      }}
                      onClick={() => setOpenRiskMappingDrawer(true)}
                    >
                      Select Risk (Cause of the Risk)
                    </Box>

                    {riskMappingIds.length > 0 && (
                      <Box sx={{ padding: '20px', display: 'flex', gap: '10px', flexWrap: 'wrap' }}>
                        {riskMappingIds.map(id => {
                          const item = risk_dropdown.find(v => v.id === id)

                          return (
                            <Box
                              key={id}
                              sx={{
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                background: `${theme.palette.company.primary}20`,
                                padding: '5px 10px 5px 5px',
                                borderRadius: '20px',
                                gap: '8px'
                              }}
                            >
                              <Box
                                sx={{
                                  width: '22px',
                                  height: '22px',
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  borderRadius: '20px',
                                  background: theme.palette.company.background,
                                  cursor: 'pointer'
                                }}
                                onClick={() => {
                                  handleRiskChange(id)
                                }}
                              >
                                <ClearRoundedIcon
                                  sx={{ width: '14px', height: '14px', color: theme.palette.company.primary }}
                                />
                              </Box>
                              <Typography
                                variant='body2'
                                sx={{ color: theme.palette.company.primary, wordBreak: 'break-all' }}
                              >
                                {item?.subject || 'Unknown'}
                              </Typography>
                            </Box>
                          )
                        })}
                      </Box>
                    )}
                  </Box>

                  <RiskMappingDrawer
                    openRiskMappingDrawer={openRiskMappingDrawer}
                    setOpenRiskMappingDrawer={setOpenRiskMappingDrawer}
                    risk_dropdown={risk_dropdown}
                    riskMappingIds={riskMappingIds}
                    handleRiskChange={handleRiskChange}
                  />

                  <FormHelperText sx={{ color: 'error.main', mx: '0px' }}>{riskError}</FormHelperText>
                </Grid>

                <Grid item xs={12}>
                  <Box sx={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}>
                    <Button
                      variant='outlined'
                      onClick={() => router.push(`/home/vulnerabilityManagement/vulnerability`)}
                      sx={{ padding: '10px 30px', width: '100px', height: '46px', margin: '0px' }}
                    >
                      {t('Cancel')}
                    </Button>
                    <Button
                      type='submit'
                      variant='secondary'
                      sx={{ padding: '10px 30px', width: '100px', height: '46px', margin: '0px' }}
                    >
                      {savingForm ? (
                        <CircularProgress size='20px' sx={{ color: theme.palette.company.background }} />
                      ) : (
                        t('Save')
                      )}
                    </Button>
                  </Box>
                </Grid>
              </Grid>
            </>
          )}
        </Box>
      </form>
    </>
  )
}

export default VulnerabilityForm
